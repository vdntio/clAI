================================================================================
                              <Unnamed CLI Tool> PRD v2
                    AI-Powered Shell Command Translator
================================================================================

PRODUCT VISION
--------------
A shell-native AI command translator that converts natural language to 
executable commands. Follows Unix philosophy: simple, composable, privacy-respecting.


================================================================================
                            DESIGN PRINCIPLES
================================================================================

+------------------+------------------------------------------------------------+
| Principle        | Implication                                                |
+------------------+------------------------------------------------------------+
| Shell Native     | Works in any POSIX shell + PowerShell; no wrapper shell    |
| Unix Philosophy  | Do one thing well; composable via pipes                    |
| Privacy First    | Local processing where possible; explicit consent for      |
|                  | external calls                                             |
| Zero Friction    | Single command → output → paste                            |
+------------------+------------------------------------------------------------+


================================================================================
                        CORE FUNCTIONAL REQUIREMENTS
================================================================================

FR-1: Natural Language → Command Translation
---------------------------------------------
FR-1.1  Accept instruction as positional argument: clai "list python files"
FR-1.2  Return ONLY the executable command to stdout
FR-1.3  Errors/warnings/prompts go to stderr (keeps stdout clean for piping)
FR-1.4  Strip markdown/code fences from AI response


FR-2: Context Injection
-----------------------
FR-2.1  System Context — OS, shell, arch, user
FR-2.2  Directory Context — cwd, top N files/dirs (configurable, default: 10)
FR-2.3  Command History — Last N commands from shell history file 
        (configurable, default: 3)
FR-2.4  Optional: Pipe stdin as additional context


FR-3: Safety & Dangerous Command Detection
------------------------------------------
FR-3.1  Configurable dangerous pattern list
FR-3.2  Match before output; warn to stderr
FR-3.3  Interactive confirmation (if TTY attached)
FR-3.4  --force flag to skip confirmation
FR-3.5  --dry-run flag to show command without execution prompt

Default Dangerous Patterns:
  - rm -rf
  - sudo rm
  - mkfs
  - dd if=
  - > /dev/
  - format


FR-4: Model Selection & Provider Abstraction
--------------------------------------------
FR-4.1  Provider-agnostic (OpenRouter first, then Anthropic, OpenAI, Ollama)
FR-4.2  Model selection via config or --model flag
FR-4.3  API key per provider in config
FR-4.4  Fallback chain (if primary fails, try next)


FR-5: Privacy Requirements
--------------------------
FR-5.1  No telemetry — ever
FR-5.2  No command logging to external services
FR-5.3  API keys stored with 600 permissions
FR-5.4  Optional: local model support (Ollama) for air-gapped use
FR-5.5  Config option to redact paths/usernames before sending to API
FR-5.6  --offline mode that fails gracefully


================================================================================
                        CLI STANDARDS COMPLIANCE
================================================================================

FR-6: Unix CLI Conventions
--------------------------
FR-6.1  --help, -h         Show usage                    [GNU]
FR-6.2  --version, -V      Show version                  [GNU]
FR-6.3  --quiet, -q        Suppress non-essential output [Common]
FR-6.4  --verbose, -v      Increase verbosity            [Common]
FR-6.5  --no-color         Disable colored output        [Common]
FR-6.6  Respect NO_COLOR env var                         [no-color.org]
FR-6.7  Respect TERM=dumb — no formatting                [POSIX]
FR-6.8  Auto-detect TTY — no color/prompts when piped    [POSIX]


FR-7: Exit Codes
----------------
+------+-----------------------------------------------------+
| Code | Meaning                                             |
+------+-----------------------------------------------------+
|  0   | Success                                             |
|  1   | General error                                       |
|  2   | Invalid usage / bad args                            |
|  3   | Config error (missing API key, bad config)          |
|  4   | API error (network, auth, rate limit)               |
|  5   | Dangerous command rejected by user                  |
+------+-----------------------------------------------------+


FR-8: Signal Handling
---------------------
+----------+-------------------------------------------+
| Signal   | Behavior                                  |
+----------+-------------------------------------------+
| SIGINT   | Cancel gracefully, exit 130               |
| SIGTERM  | Clean shutdown                            |
| SIGPIPE  | Exit silently (for pipe chains)           |
+----------+-------------------------------------------+


FR-9: Configuration Hierarchy
-----------------------------
Priority (highest → lowest):
  1. CLI flags
  2. Environment variables (CLAI_MODEL, CLAI_PROVIDER, etc.)
  3. Local config (./.clai.toml)
  4. User config ($XDG_CONFIG_HOME/clai/config.toml or 
     ~/.config/clai/config.toml)
  5. System config (/etc/clai/config.toml)
  6. Defaults


FR-10: Shell Integration
------------------------
FR-10.1  Provide shell completion scripts (bash, zsh, fish, PowerShell)
FR-10.2  Read shell history from standard locations 
         (~/.bash_history, ~/.zsh_history, etc.)
FR-10.3  Optional shell function for execute-on-confirm workflow
FR-10.4  Composable: clai "find large files" | pbcopy should work


FR-11: Stdin/Stdout/Stderr Separation
-------------------------------------
+----------+------------------------------------------------------+
| Stream   | Content                                              |
+----------+------------------------------------------------------+
| stdout   | Generated command only (clean, pipeable)             |
| stderr   | Prompts, warnings, errors, verbose output            |
| stdin    | Optional additional context (e.g., error to debug)   |
+----------+------------------------------------------------------+

Examples:
  # Pipe error into context
  cat error.log | clai "fix this error"

  # Copy command to clipboard
  clai "list docker containers" | pbcopy

  # Direct execution (dangerous, but possible)
  eval $(clai "list files" --force)


================================================================================
                                UX FLOW
================================================================================

Simple Mode (default)
---------------------
  $ clai "find files larger than 100mb"
  find . -size +100M -type f

  # User manually copies/pastes or pipes


Interactive Mode (-i)
---------------------
  $ clai -i "delete node_modules"
  ⚠️  Dangerous command detected (stderr)

  rm -rf node_modules

  [E]xecute / [C]opy / [A]bort?


Quiet Mode (-q)
---------------
  $ clai -q "list python files" | xargs wc -l
  # Only outputs command, no spinners/status


================================================================================
                          CONFIGURATION FILE
================================================================================

Example config.toml:

  [provider]
  default = "openrouter"
  fallback = ["ollama"]

  [openrouter]
  api_key_env = "OPENROUTER_API_KEY"  # Reference env var, don't store key
  model = "anthropic/claude-3.5-sonnet"

  [ollama]
  endpoint = "http://localhost:11434"
  model = "llama3"

  [context]
  max_files = 10
  max_history = 3
  redact_paths = false
  redact_username = false

  [safety]
  dangerous_patterns = [
    "rm -rf",
    "sudo rm",
    "mkfs",
    "dd if=",
    "> /dev/",
    "format"
  ]
  confirm_dangerous = true

  [ui]
  color = "auto"  # auto | always | never


================================================================================
                              OPTIMIZATIONS
================================================================================

+-------------------+----------------------------------------------------------+
| Area              | Strategy                                                 |
+-------------------+----------------------------------------------------------+
| Startup Time      | Lazy-load config; no heavy deps at import               |
| Token Efficiency  | Cap context; truncate long paths                         |
| Caching           | Cache system info (static per session)                   |
| Pattern Matching  | Pre-compile dangerous patterns at startup                |
| History Reading   | Tail-read shell history file (don't load entire file)    |
+-------------------+----------------------------------------------------------+


================================================================================
                            OUT OF SCOPE (v1)
================================================================================

- REPL/interactive shell mode
- Command chaining from single instruction
- Undo/rollback
- Remote execution
- Syntax highlighting of output command
- Built-in execution (user pastes/pipes manually)


================================================================================
                              CLI REFERENCE
================================================================================

  clai [OPTIONS] <INSTRUCTION>

  Arguments:
    <INSTRUCTION>           Natural language instruction

  Options:
    -m, --model <MODEL>     Override model
    -p, --provider <NAME>   Override provider
    -i, --interactive       Prompt for execute/copy/abort
    -f, --force             Skip dangerous command confirmation
    -n, --dry-run           Show command without prompts
    -c, --context <FILE>    Additional context file
    -q, --quiet             Minimal output
    -v, --verbose           Debug output
        --no-color          Disable colors
    -h, --help              Show help
    -V, --version           Show version


================================================================================
                            SUCCESS METRICS
================================================================================

+------------------------+---------------------------------------------------+
| Metric                 | Target                                            |
+------------------------+---------------------------------------------------+
| Startup time           | <50ms (excluding API call)                        |
| Command accuracy       | >85% valid on first try                           |
| Dangerous catch rate   | 100%                                              |
| Stdout cleanliness     | 100% (only command, nothing else)                 |
+------------------------+---------------------------------------------------+


================================================================================
                    ADDITIONAL CLI STANDARDS REFERENCE
================================================================================

+-------------------------+-----------------------------------------------+
| Standard                | Description                                   |
+-------------------------+-----------------------------------------------+
| XDG Base Directory      | Config/cache/data locations (freedesktop.org) |
| NO_COLOR                | Env var to disable color (no-color.org)       |
| CLICOLOR / CLICOLOR_FORCE | macOS color conventions                     |
| GNU Argument Syntax     | --long, -s, --key=value                       |
| Fish/Zsh Completions    | Dynamic completions (shell-specific)          |
| Man Page                | man clai should work (troff/mandoc format)     |
| SIGPIPE Handling        | Don't error when piped to head (POSIX)        |
| Locale Awareness        | Respect LANG, LC_* for messages (POSIX)       |
+-------------------------+-----------------------------------------------+


================================================================================
                              END OF DOCUMENT
================================================================================